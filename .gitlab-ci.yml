# Unified GitLab CI/CD Pipeline for Full-Stack Application
# Frontend: Next.js | Backend: FastAPI

image: docker:latest

stages:
  - validate
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_BUILDKIT: "1"
  DOCKER_HOST: tcp://docker:2376
  AWS_DEFAULT_REGION: ap-south-1

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_TAG

.backend_rules:
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop" || $CI_MERGE_REQUEST_IID
      changes:
        - backend/**/*
        - backend/*
      when: on_success
    - when: never

.frontend_rules:
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop" || $CI_MERGE_REQUEST_IID
      changes:
        - "*.json"
        - "*.js"
        - "*.ts"
        - "*.mjs"
        - "*.cjs"
        - "*.lock"
        - "*.config.*"
        - ".env*"
        - ".eslint*"
        - ".prettier*"
        - "Dockerfile*"
        - "next.config.*"
        - "tailwind.config.*"
        - "tsconfig.*"
        - "postcss.config.*"
        - src/**/*
        - app/**/*
        - pages/**/*
        - components/**/*
        - lib/**/*
        - public/**/*
        - styles/**/*
        - hooks/**/*
        - utils/**/*
        - types/**/*
        - contexts/**/*
        - services/**/*
        - store/**/*
        - assets/**/*
        - config/**/*
        - middleware/**/*
        - prisma/**/*
        - scripts/**/*
        - __tests__/**/*
        - tests/**/*
        - e2e/**/*
        - cypress/**/*
        - .github/**/*
        - .husky/**/*
        - node_modules/**/*
      when: on_success
    - when: never

# =============================================================================
# BACKEND PIPELINE JOBS
# =============================================================================

backend:validate:
  stage: validate
  image: docker/compose:latest
  extends: .backend_rules
  script:
    - cd backend
    - echo "POSTGRES_USER=postgres" > .env
    - echo "POSTGRES_PASSWORD=test" >> .env
    - echo "POSTGRES_DB=test" >> .env
    - echo "NEO4J_USER=neo4j" >> .env
    - echo "NEO4J_PASSWORD=test" >> .env
    - echo "PGADMIN_EMAIL=admin@test.local" >> .env
    - echo "PGADMIN_PASSWORD=test" >> .env
    - docker-compose -f docker-compose.api.yml config --quiet
    - echo "Docker Compose configuration is valid"

backend:build:
  stage: build
  image: docker:latest
  extends: .backend_rules
  services:
    - docker:dind
  variables:
    DOCKER_TLS_VERIFY: "1"
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  script:
    - cd backend
    - echo "POSTGRES_USER=postgres" > .env
    - echo "POSTGRES_PASSWORD=ci_password" >> .env
    - echo "POSTGRES_DB=fazri_ci" >> .env
    - echo "NEO4J_USER=neo4j" >> .env
    - echo "NEO4J_PASSWORD=ci_password" >> .env
    - echo "PGADMIN_EMAIL=admin@ci.local" >> .env
    - echo "PGADMIN_PASSWORD=ci_password" >> .env
    - echo "CI_REGISTRY_IMAGE=${CI_REGISTRY_IMAGE}/backend" >> .env
    - echo "CI_COMMIT_REF_SLUG=${CI_COMMIT_SHORT_SHA}" >> .env
    - apk add --no-cache docker-compose
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
    - docker-compose -f docker-compose.api.yml build app
    - docker tag "${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_REF_SLUG:-latest}" "${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}"
    - docker push "${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}"
    - echo "Built and pushed backend image"

backend:deploy:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: https://gitlab.com
  variables:
    ROLE_ARN: arn:aws:iam::955719296501:role/ec2-ssm-gitlab
    EC2_INSTANCE_ID: i-091d1dcb0c1358f59
    BACKEND_CONTAINER_NAME: fazri-api
  script:
    - curl -s "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "session-manager-plugin.deb"
    - dpkg -i session-manager-plugin.deb
    - mkdir -p ~/.aws
    - echo "${GITLAB_OIDC_TOKEN}" > /tmp/web_identity_token
    - printf "[profile default]\nrole_arn=%s\nweb_identity_token_file=/tmp/web_identity_token" "${ROLE_ARN}" > ~/.aws/config
    - aws sts get-caller-identity
    - echo "Deploying backend image"
    - aws ssm send-command --document-name "AWS-RunShellScript" --targets "Key=instanceIds,Values=${EC2_INSTANCE_ID}" --parameters "commands=[\"echo ${CI_REGISTRY_PASSWORD} | docker login ${CI_REGISTRY} -u ${CI_REGISTRY_USER} --password-stdin\",\"docker pull ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}\",\"docker stop ${BACKEND_CONTAINER_NAME} || true\",\"docker rm ${BACKEND_CONTAINER_NAME} || true\",\"docker run -d --restart unless-stopped -p 8000:8000 -e POSTGRES_USER=${POSTGRES_USER} -e POSTGRES_PASSWORD=${POSTGRES_PASSWORD} -e POSTGRES_DB=${POSTGRES_DB} -e NEO4J_URI=${NEO4J_URI} -e NEO4J_USER=${NEO4J_USER} -e NEO4J_PASSWORD=${NEO4J_PASSWORD} -e REDIS_HOST=${REDIS_HOST} -e REDIS_PORT=${REDIS_PORT} -e ENVIRONMENT=production --name ${BACKEND_CONTAINER_NAME} ${CI_REGISTRY_IMAGE}/backend:${CI_COMMIT_SHORT_SHA}\"]" --output text
    - sleep 30
    - echo "Backend deployment command sent"
  environment:
    name: production-backend
    url: http://${BACKEND_EC2_HOST}:8000
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
      changes:
        - backend/**/*
        - backend/*
      when: on_success
    - when: never

# =============================================================================
# FRONTEND PIPELINE JOBS
# =============================================================================

frontend:build:
  stage: build
  image: docker:latest
  extends: .frontend_rules
  services:
    - docker:27.2.0-dind
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
    - docker build --build-arg NEXT_PUBLIC_FASTAPI_BASE_URL="$NEXT_PUBLIC_FASTAPI_BASE_URL" --build-arg NEXT_PUBLIC_CDN_URL="$NEXT_PUBLIC_CDN_URL" -t "${CI_REGISTRY_IMAGE}/frontend:${CI_COMMIT_SHORT_SHA}" -f Dockerfile.prod .
    - docker push "${CI_REGISTRY_IMAGE}/frontend:${CI_COMMIT_SHORT_SHA}"
    - echo "Built and pushed frontend image"

frontend:deploy:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: https://gitlab.com
  variables:
    ROLE_ARN: arn:aws:iam::955719296501:role/ec2-ssm-gitlab
    EC2_INSTANCE_ID: i-091d1dcb0c1358f59
    FRONTEND_CONTAINER_NAME: nextjs-app
  script:
    - curl -s "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "session-manager-plugin.deb"
    - dpkg -i session-manager-plugin.deb
    - mkdir -p ~/.aws
    - echo "${GITLAB_OIDC_TOKEN}" > /tmp/web_identity_token
    - printf "[profile default]\nrole_arn=%s\nweb_identity_token_file=/tmp/web_identity_token" "${ROLE_ARN}" > ~/.aws/config
    - aws sts get-caller-identity
    - echo "Deploying frontend image"
    - aws ssm send-command --document-name "AWS-RunShellScript" --targets "Key=instanceIds,Values=${EC2_INSTANCE_ID}" --parameters "commands=[\"echo ${CI_REGISTRY_PASSWORD} | docker login ${CI_REGISTRY} -u ${CI_REGISTRY_USER} --password-stdin\",\"docker pull ${CI_REGISTRY_IMAGE}/frontend:${CI_COMMIT_SHORT_SHA}\",\"docker stop ${FRONTEND_CONTAINER_NAME} || true\",\"docker rm ${FRONTEND_CONTAINER_NAME} || true\",\"docker run -d --restart unless-stopped -p 3000:3000 -e NEXTAUTH_URL=${NEXTAUTH_URL} -e NEXTAUTH_SECRET=${NEXTAUTH_SECRET} -e AUTH_GOOGLE_ID=${AUTH_GOOGLE_ID} -e AUTH_GOOGLE_SECRET=${AUTH_GOOGLE_SECRET} -e DATABASE_URL=${DATABASE_URL} --name ${FRONTEND_CONTAINER_NAME} ${CI_REGISTRY_IMAGE}/frontend:${CI_COMMIT_SHORT_SHA}\"]" --output text
    - sleep 30
    - echo "Frontend deployment command sent"
  environment:
    name: production-frontend
    url: http://${FRONTEND_EC2_HOST}:3000
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
      changes:
        - "*.json"
        - "*.js"
        - "*.ts"
        - "*.mjs"
        - "*.cjs"
        - "*.lock"
        - "*.config.*"
        - ".env*"
        - "Dockerfile*"
        - "next.config.*"
        - "tailwind.config.*"
        - "tsconfig.*"
        - "postcss.config.*"
        - src/**/*
        - app/**/*
        - pages/**/*
        - components/**/*
        - lib/**/*
        - public/**/*
        - styles/**/*
        - hooks/**/*
        - utils/**/*
        - types/**/*
        - contexts/**/*
        - services/**/*
        - store/**/*
        - assets/**/*
        - config/**/*
        - prisma/**/*
      when: on_success
    - when: never

# =============================================================================
# ROLLBACK JOBS (Manual trigger)
# =============================================================================

backend:rollback:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: https://gitlab.com
  variables:
    ROLE_ARN: arn:aws:iam::955719296501:role/ec2-ssm-gitlab
    EC2_INSTANCE_ID: i-091d1dcb0c1358f59
  script:
    - curl -s "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "session-manager-plugin.deb"
    - dpkg -i session-manager-plugin.deb
    - mkdir -p ~/.aws
    - echo "${GITLAB_OIDC_TOKEN}" > /tmp/web_identity_token
    - printf "[profile default]\nrole_arn=%s\nweb_identity_token_file=/tmp/web_identity_token" "${ROLE_ARN}" > ~/.aws/config
    - aws sts get-caller-identity
    - aws ssm send-command --document-name "AWS-RunShellScript" --targets "Key=instanceIds,Values=${EC2_INSTANCE_ID}" --parameters "commands=[\"docker restart fazri-api || echo Container restart failed\"]" --output text
    - echo "Rollback command sent"
  environment:
    name: production-backend
  when: manual
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

frontend:rollback:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: https://gitlab.com
  variables:
    ROLE_ARN: arn:aws:iam::955719296501:role/ec2-ssm-gitlab
    EC2_INSTANCE_ID: i-091d1dcb0c1358f59
  script:
    - curl -s "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "session-manager-plugin.deb"
    - dpkg -i session-manager-plugin.deb
    - mkdir -p ~/.aws
    - echo "${GITLAB_OIDC_TOKEN}" > /tmp/web_identity_token
    - printf "[profile default]\nrole_arn=%s\nweb_identity_token_file=/tmp/web_identity_token" "${ROLE_ARN}" > ~/.aws/config
    - aws sts get-caller-identity
    - aws ssm send-command --document-name "AWS-RunShellScript" --targets "Key=instanceIds,Values=${EC2_INSTANCE_ID}" --parameters "commands=[\"docker restart nextjs-app || echo Container restart failed\"]" --output text
    - echo "Rollback command sent"
  environment:
    name: production-frontend
  when: manual
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"